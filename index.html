<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falling Sand Game Replica</title>

    <!-- Bootstrap 5 for nicer buttons and FontAwesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0-alpha1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black; /* Set the background of the body to black */
        }

        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 600px;
            margin: 0 auto;
            border: 5px solid #fff;
            background-color: #000;
            padding: 5px; /* Add padding inside the container */
            box-sizing: border-box; /* Prevent border from pushing out the content */
        }

        canvas {
            display: block;
            background: #000;
            margin: 0 auto;
        }

        #controls {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .btn {
            font-size: 16px;
            margin: 0 10px;
        }

        .btn i {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
</div>

<div id="controls">
    <button id="sand" class="btn btn-warning"><i class="fas fa-cogs"></i>Sand</button>
    <button id="water" class="btn btn-primary"><i class="fas fa-tint"></i>Water</button>
    <button id="oil" class="btn btn-secondary"><i class="fas fa-oil-can"></i>Oil</button>
    <button id="fire" class="btn btn-danger"><i class="fas fa-fire"></i>Fire</button>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
$(document).ready(function () {
    const canvas = $('#gameCanvas')[0];
    const ctx = canvas.getContext('2d');

    // Set canvas size and make it responsive
    const canvasSize = 600;
    canvas.width = canvasSize;
    canvas.height = canvasSize;

    // Grid size for particles
    const gridSize = 2;
    const gridWidth = Math.floor(canvas.width / gridSize);
    const gridHeight = Math.floor(canvas.height / gridSize);

    // Create a grid to store particle types
    const grid = Array.from({ length: gridWidth }, () => Array(gridHeight).fill(null));

    // Variables to track selected material
    let selectedMaterial = 'sand';  // Default to sand
    const sandColor = '#d4c239';
    const waterColor = '#3a96d1';
    const oilColor = '#c2b280';
    const fireColor = '#ff4500';  // Fire color

    // Particle Types
    const SAND = 'sand';
    const WATER = 'water';
    const OIL = 'oil';
    const FIRE = 'fire';

    // Initialize game loop
    let lastTime = 0;

    // Function to randomly spawn particles
    function randomParticles(count) {
        for (let i = 0; i < count; i++) {
            const x = Math.floor(Math.random() * gridWidth);
            const y = Math.floor(Math.random() * gridHeight / 2); // Start in the top half of the screen
            grid[x][y] = selectedMaterial;
        }
    }

    // Draw grid
    function drawGrid() {
        for (let x = 0; x < gridWidth; x++) {
            for (let y = 0; y < gridHeight; y++) {
                const material = grid[x][y];
                if (material === SAND) {
                    ctx.fillStyle = sandColor;
                } else if (material === WATER) {
                    ctx.fillStyle = waterColor;
                } else if (material === OIL) {
                    ctx.fillStyle = oilColor;
                } else if (material === FIRE) {
                    ctx.fillStyle = fireColor;
                } else {
                    continue;
                }
                ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
            }
        }
    }

    // Update particles
    function updateParticles() {
        for (let x = 0; x < gridWidth; x++) {
            for (let y = gridHeight - 1; y >= 0; y--) {
                const material = grid[x][y];
                if (!material) continue; // No particle

                // Gravity effect - move down
                if (y + 1 < gridHeight && !grid[x][y + 1]) {
                    grid[x][y + 1] = material;
                    grid[x][y] = null;
                }

                // Water behavior: Spread sideways
                else if (material === WATER) {
                    if (x + 1 < gridWidth && !grid[x + 1][y + 1]) {
                        grid[x + 1][y + 1] = material;
                        grid[x][y] = null;
                    } else if (x - 1 >= 0 && !grid[x - 1][y + 1]) {
                        grid[x - 1][y + 1] = material;
                        grid[x][y] = null;
                    }
                }

                // Oil behavior: Float on water
                else if (material === OIL) {
                    if (y + 1 < gridHeight && !grid[x][y + 1]) {
                        grid[x][y + 1] = material;
                        grid[x][y] = null;
                    } else if (y + 1 < gridHeight && grid[x][y + 1] === WATER) {
                        grid[x][y] = null; // Oil floats on water, so it doesn't move down
                    }
                }

                // Fire behavior: Fire rises and flickers
                else if (material === FIRE) {
                    if (y - 1 >= 0 && !grid[x][y - 1]) {
                        grid[x][y - 1] = FIRE; // Fire moves up
                        grid[x][y] = null;
                    }

                    // Spread fire to neighboring cells
                    if (Math.random() < 0.2) {
                        const dx = Math.floor(Math.random() * 3) - 1;
                        const dy = Math.floor(Math.random() * 3) - 1;
                        if (x + dx >= 0 && x + dx < gridWidth && y + dy >= 0 && y + dy < gridHeight) {
                            if (grid[x + dx][y + dy] === null) {
                                grid[x + dx][y + dy] = FIRE;
                            }
                        }
                    }

                    // Fire should be extinguished by water
                    if (y + 1 < gridHeight && grid[x][y + 1] === WATER) {
                        grid[x][y] = null; // Fire extinguishes when it touches water
                    }
                }
            }
        }
    }

    // Mouse Interaction (hold mouse button to spawn particles)
    let isMousePressed = false;
    let lastDropTime = 0;
    const dropInterval = 30; // Milliseconds between particle drops when holding mouse

    $(canvas).on('mousedown', function (event) {
        isMousePressed = true;
        const offsetX = event.pageX - $(canvas).offset().left;
        const offsetY = event.pageY - $(canvas).offset().top;
        const x = Math.floor(offsetX / gridSize);
        const y = Math.floor(offsetY / gridSize);
        if (grid[x] && grid[x][y] === null) {
            grid[x][y] = selectedMaterial;
        }
    }).on('mouseup', function () {
        isMousePressed = false;
    }).on('mousemove', function (event) {
        if (isMousePressed) {
            const offsetX = event.pageX - $(canvas).offset().left;
            const offsetY = event.pageY - $(canvas).offset().top;
            const x = Math.floor(offsetX / gridSize);
            const y = Math.floor(offsetY / gridSize);
            if (grid[x] && grid[x][y] === null) {
                grid[x][y] = selectedMaterial;
            }
        }
    });

    // Select material
    $('#sand').on('click', function () {
        selectedMaterial = SAND;
    });

    $('#water').on('click', function () {
        selectedMaterial = WATER;
    });

    $('#oil').on('click', function () {
        selectedMaterial = OIL;
    });

    $('#fire').on('click', function () {
        selectedMaterial = FIRE;
    });

    // Game Loop
    function gameLoop() {
        updateParticles();
        drawGrid();
        requestAnimationFrame(gameLoop);
    }

    // Start game loop
    gameLoop();
});
</script>
</body>
</html>
